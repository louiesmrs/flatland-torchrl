name: CARBS sweep (Flatland)

on:
  workflow_dispatch: {}

jobs:
  carbs-sweep:
    runs-on: ubuntu-latest
    environment: flatland
    env:
      WANDB_API_KEY: ${{ secrets.WANDB_API_KEY }}
    timeout-minutes: 360

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install uv
        uses: astral-sh/setup-uv@v3

      - name: Init submodules
        run: git submodule update --init --recursive

      - name: Sync dependencies
        run: uv sync --reinstall

      - name: Install dev tools
        run: uv pip install -r tools/requirements.txt

      - name: Install BenchMARL
        run: uv pip install ./benchmarl_ext

      - name: Build flatland_cutils
        run: uv pip install ./flatland_cutils

      - name: Run PufferLib sweep
        run: |
          bash -lc "uv run python scripts/puffer_sweep.py --trials 5" | tee puffer_output.txt

      - name: Upload sweep results
        uses: actions/upload-artifact@v4
        with:
          name: puffer_results
          path: |
            puffer_runs/results.jsonl
            puffer_output.txt

      - name: Write summary
        run: |
          echo "## Puffer Sweep Summary" >> $GITHUB_STEP_SUMMARY
          echo "- Results file: puffer_runs/results.jsonl" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Last 5 results" >> $GITHUB_STEP_SUMMARY
          tail -n 5 puffer_runs/results.jsonl >> $GITHUB_STEP_SUMMARY || true
